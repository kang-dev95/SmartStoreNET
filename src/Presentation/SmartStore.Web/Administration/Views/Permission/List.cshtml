@using SmartStore.Collections
@using SmartStore.Core.Domain.Security
@model PermissionListModel
@{               
    ViewBag.Title = T("Admin.Configuration.ACL").Text;
}

@using (Html.BeginForm())
{
    <input type="hidden" name="roleId" value="@Model.RoleId" />

    <div class="section-header">
        <div class="title">
            <i class="fa fa-lock"></i>
            @T("Admin.Configuration.ACL")
        </div>
        <div class="options">
            <button type="submit" class="btn btn-warning">
			    <i class="fa fa-check"></i>
			    <span>@T("Admin.Common.Save")</span>
		    </button>
        </div>
    </div>
    
    <div class="row mt-3 grid-filter">
	    <div class="col-sm-6 col-lg-4 col-xl-3 form-group">
		    @Html.SmartLabelFor(model => model.RoleId)
		    @Html.DropDownListFor(model => model.RoleId, Model.Roles)
	    </div>
    </div>

    <div id="permission-tree" class="smtree mt-3">
        @if (Model.PermissionTree != null && Model.PermissionTree.HasChildren)
        {
            @PermissionNode(Model.PermissionTree)
        }
        else
        {
	        <div class="alert alert-warning">
		        @T("Admin.System.Warnings.NoPermissionsDefined")
	        </div>
        }
    </div>
}

@helper PermissionNode(TreeNode<IPermissionNode> node)
{
    <ul>
        @foreach (var child in node.Children)
        {
            var value = child.Value.Allow.HasValue ? (child.Value.Allow.Value ? 2 : 1) : 0;
            <li data-name="permission-@child.Value.PermissionRecordId" data-value="@value" data-label="@child.Value.SystemName">
                @if (child.HasChildren)
                {
                    @PermissionNode(child)
                }
            </li>
        }
    </ul>
}


<script>
    $(function () {
        // Init tree.
        $('#permission-tree').smTree({
            nodeState: 'tri'
        });

        // Load permission tree for selected role.
		$('#@Html.FieldIdFor(x => x.RoleId)').change(function () {
            location.href = '@Url.Action("List")?roleId=' + $(this).val();			
		});
	});
</script>